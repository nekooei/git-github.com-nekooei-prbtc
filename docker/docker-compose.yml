version: '3.8'

services:
  mining-proxy:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    ports:
      - "3333:3333"  # Stratum port
      - "9090:9090"  # Metrics port
    environment:
      - POOL_HOST=${POOL_HOST:-btc.viabtc.io}
      - POOL_PORT=${POOL_PORT:-3333}
      - BIND_ADDRESS=0.0.0.0
      - BIND_PORT=3333
      - METRICS_PORT=9090
      - LOG_LEVEL=info
      - MAX_CONNECTIONS=100
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9091:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    restart: unless-stopped

volumes:
  prometheus-data:
